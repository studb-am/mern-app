events {}

http {
    include /etc/nginx/mime.types;

    upstream map_stream {
	server map_server:80;
    }

    server {
       
	listen 80;
        server_name _;
	return 301 "https://$host$request_uri";
    }

    server {
	
	listen 443 ssl;
	server_name locomovolt.com;
	ssl_certificate     /etc/letsencrypt/live/locomovolt.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/locomovolt.com/privkey.pem;
        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers         HIGH:!aNULL:!MD5;        

	#local path for the map style
        location = /api/map/styles/basic-preview/style.json {
		proxy_pass 'http://map_stream/styles/basic-preview/style.json';
	}

	#local path for the map data
	location = /api/map/data/v3.json {
		proxy_pass 'http://map_stream/data/v3.json';
	}

	#local path for sprite (png extension)
	location ~ \/api\/map\/styles\/basic-preview\/sprite(\@2x\.|\.)(json|png) {
		proxy_pass "http://map_stream/styles/basic-preview/sprite$1$2";
	}


	#local path for fonts
	location ~ \/api\/map\/fonts\/(\w+)\/(w+)\.pbf {
		proxy_pass "http://map_stream/fonts/$1/$2.pbf";
	}	
    }
}
